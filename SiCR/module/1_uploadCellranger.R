# --- UIã®å®šç¾©: uploadCellrangerUI ---
uploadCellrangerUI <- function(id) {
  ns <- NS(id)
  fluidRow(
    column(6,
      offset = 1,
      shinyjs::useShinyjs(),
      
      tags$div(
        style = "border: 0.5px solid #000; padding: 10px;",
        tags$p("Please upload the filtered_feature_bc_matrix.h5 file generated by cellranger. You can optionally upload the T cell receptor file (filtered_contig_annotations.csv) and/or the B cell receptor file (filtered_contig_annotations.csv)."),
        tags$p("After uploading, click the Run button.")
      ),
      tags$div(style = "margin-top: 10px;"),
      
      fluidRow(
        column(8, fileInput(ns("h5"), "1. Choose .h5 file")),
        column(4, style = "margin-top: 25px;", uiOutput(ns("h5_status_ui")))
      ),
      fluidRow(
        column(8, fileInput(ns("tcr"), "2. Choose .tcr file (optional)")),
        column(4, style = "margin-top: 25px;", uiOutput(ns("tcr_status_ui")))
      ),
      fluidRow(
        column(8, fileInput(ns("bcr"), "3. Choose .bcr file (optional)")),
        column(4, style = "margin-top: 25px;", uiOutput(ns("bcr_status_ui")))
      ),
      
      # ### å¤‰æ›´ç‚¹ ###
      # ãƒœã‚¿ãƒ³ã‚’"Run"ã®ä¸€ã¤ã«ã¾ã¨ã‚ã¾ã—ãŸ
      fluidRow(
        column(3, actionButton(ns("run"), "Run", icon = icon("rocket"))),
        column(5,
               shinyjs::hidden(
                 downloadButton(ns("download_results"), "Download Results (.rds)")
               )
        )
      ),
      
      shinyjs::hidden(
        tags$div(id = ns("status_message"),
                 style = "margin-top: 15px; padding: 10px; border-radius: 5px; background-color: #f0f0f0;")
      )
    )
  )
}

# ==============================================================================
# Server ãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ)
# ==============================================================================
uploadCellrangerServer <- function(id, myReactives) {
  moduleServer(id, function(input, output, session) {
    ns <- session$ns

    output$h5_status_ui <- renderUI({ req(input$h5); tags$p("âœ… Uploaded!", style = "color: green;") })
    output$tcr_status_ui <- renderUI({ req(input$tcr); tags$p("âœ… Uploaded!", style = "color: green;") })
    output$bcr_status_ui <- renderUI({ req(input$bcr); tags$p("âœ… Uploaded!", style = "color: green;") })

    observeEvent(input$run, {
      # --- 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å®šç¾© ---
      cache_file_path <- "analysis_cache.rds"

      # --- 2. å…¥åŠ›ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯ ---
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªãã€ã‹ã¤.h5ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
      if (!file.exists(cache_file_path) && is.null(input$h5$datapath)) {
        shinyalert::shinyalert("Input Required", "Please upload the .h5 file for the first analysis.", type = "error")
        return()
      }

      # --- 3. UIã®åˆæœŸåŒ– ---
      shinyjs::hide("download_results")
      shinyjs::disable("run")
      shinyjs::show("status_message")

      withProgress(message = 'Analysis in progress', value = 0, {
        # --- 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®èª­ã¿è¾¼ã¿ã€ã¾ãŸã¯æ–°è¦è§£æã®å®Ÿè¡Œ ---
        # å¤‰æ›´ç‚¹: h5ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã«ã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã‚€
        if (file.exists(cache_file_path) && is.null(input$h5$datapath)) {
          # --- [A] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼šèª­ã¿è¾¼ã‚“ã§ã‚¹ã‚­ãƒƒãƒ— ---
          shinyjs::html(id = "status_message", html = paste0("<p style='color: #8A2BE2;'>ğŸ“ Found '", cache_file_path, "'. Loading cached analysis results...</p>"))
          incProgress(0.2, detail = "Loading cached data...")

          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
          cached_data <- readRDS(cache_file_path)

          # myReactivesã®å„é …ç›®ã‚’å¾©å…ƒ
          for (name in names(cached_data)) {
            myReactives[[name]] <- cached_data[[name]]
          }

          incProgress(0.8, detail = "Cached data loaded successfully.")
          message(paste("âœ… Successfully loaded all analysis results from", cache_file_path))

        } else {
          # --- [B] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼šæ–°è¦è§£æã‚’å®Ÿè¡Œ ---
          shinyjs::html(id = "status_message", html = "<p style='color: blue;'>ğŸš€ Starting new analysis pipeline... (This may take a while)</p>")

          # (1) ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å‰²ã‚Šå½“ã¦
          incProgress(0.1, detail = "Assigning file paths...")
          myReactives <- fileUpload(input, myReactives)

          # (2) .h5ã‹ã‚‰Seuratã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
          incProgress(0.1, detail = "Loading .h5 file...")
          myReactives <- h5_to_seurat_object(myReactives)

          # (3) Seuratæ¨™æº–è§£æ (Normalization, PCA, UMAP, etc.)
          incProgress(0.2, detail = "Running basic Seurat processing...")
          myReactives <- run_seurat_object(myReactives) # ã“ã®é–¢æ•°ã¯å†…éƒ¨ã§Seuratã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°

          # (4) scTypeã«ã‚ˆã‚‹ç´°èƒã‚¿ã‚¤ãƒ”ãƒ³ã‚°
          incProgress(0.1, detail = "Performing cell typing with scType...")
          tryCatch({
            message("--- Starting scType analysis ---")
            myReactives$seurat_object <- run_sctype_and_update_seurat(myReactives$seurat_object)
            message("--- scType analysis finished successfully ---")
          }, error = function(e) {
            message("!!!!!!!!!! scType Error Caught !!!!!!!!!!")
            message("Error message: ", e$message)
            shinyalert::shinyalert("scType Error", paste("Cell typing failed:", e$message), type = "error")
          })

          # (5) TCRãƒ‡ãƒ¼ã‚¿å‡¦ç†
          if (!is.null(myReactives$tcr_path)) {
            incProgress(0.1, detail = "Processing TCR data...")
            req(myReactives$seurat_object)
            myReactives$tcr_df <- tcr_csv_to_dataframe(myReactives$tcr_path)
            
            # Seuratãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
            seurat_barcodes <- rownames(myReactives$seurat_object@meta.data)
            myReactives$tcr_df <- myReactives$tcr_df %>%
              dplyr::filter(barcode %in% seurat_barcodes)
            
            metadata <- myReactives$seurat_object@meta.data %>%
              tibble::rownames_to_column(var = "barcode") %>% 
              dplyr::select(any_of(c("sample", "seurat_clusters")), barcode)
            myReactives$tcr_df <- dplyr::left_join(myReactives$tcr_df, metadata, by = "barcode")
            
            # 'tcr_status' åˆ—ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
            message("--- Adding 'tcr_status' column to Seurat metadata ---")
            seurat_barcodes <- rownames(myReactives$seurat_object@meta.data)
            tcr_barcodes <- myReactives$tcr_df$barcode
            myReactives$seurat_object$tcr_status <- ifelse(seurat_barcodes %in% tcr_barcodes, "TCR positive", "TCR negative")
            message("'tcr_status' column added. Summary:")
            print(table(myReactives$seurat_object@meta.data$tcr_status))
          }

          # (6) BCRãƒ‡ãƒ¼ã‚¿å‡¦ç†
          if (!is.null(myReactives$bcr_path)) {
            incProgress(0.1, detail = "Processing BCR data...")
            req(myReactives$seurat_object)
            myReactives$bcr_df <- bcr_csv_to_dataframe(myReactives$bcr_path) # ä¿®æ­£: æ­£ã—ã„é–¢æ•°ã‚’å‘¼ã³å‡ºã™
            
            seurat_barcodes <- rownames(myReactives$seurat_object@meta.data)
            myReactives$bcr_df <- myReactives$bcr_df %>%
              dplyr::filter(barcode %in% seurat_barcodes)
              
            metadata <- myReactives$seurat_object@meta.data %>%
              tibble::rownames_to_column(var = "barcode") %>%
              dplyr::select(any_of(c("sample", "seurat_clusters")), barcode)
            myReactives$bcr_df <- dplyr::left_join(myReactives$bcr_df, metadata, by = "barcode")

            message("--- Adding 'bcr_status' column to Seurat metadata ---")
            seurat_barcodes <- rownames(myReactives$seurat_object@meta.data)
            bcr_barcodes <- myReactives$bcr_df$barcode
            myReactives$seurat_object$bcr_status <- ifelse(seurat_barcodes %in% bcr_barcodes, "BCR positive", "BCR negative")
            message("'bcr_status' column added. Summary:")
            print(table(myReactives$seurat_object@meta.data$bcr_status))
          }
          
          # (7) è§£æçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ä¿å­˜
          incProgress(0.1, detail = "Finalizing and saving results to cache...")
          results_to_save <- reactiveValuesToList(myReactives)
          saveRDS(results_to_save, file = cache_file_path)
          message(paste("--- âœ… Analysis complete. Results saved to", cache_file_path, "---"))
        }
      }) # withProgressã®çµ‚ã‚ã‚Š

      # --- 5. å®Œäº†å‡¦ç† ---
      shinyjs::html(id = "status_message", html = "<p style='color: green;'>ğŸ‰ Analysis finished successfully!</p>")
      shinyjs::enable("run")
      shinyjs::show("download_results")
      shinyjs::delay(5000, shinyjs::hide("status_message"))
    })

    output$download_results <- downloadHandler(
      filename = function() {
        # ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«åã¨åˆã‚ã›ã‚‹
        "analysis_cache.rds"
      },
      content = function(file) {
        # ã‚µãƒ¼ãƒãƒ¼ä¸Šã«å­˜åœ¨ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
        file.copy("analysis_cache.rds", file)
      }
    )

  })
}

# ==============================================================================
# scType å®Ÿè¡Œã®ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ã)
# ==============================================================================
#' @title scType ã‚’å®Ÿè¡Œã—ã€Seuratã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°ã™ã‚‹
#' @description Seuratã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã€scTypeã«ã‚ˆã‚‹ã‚»ãƒ«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã€
#'              çµæœã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã« `sctype_celltype` ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
#' @param seurat_obj `Seurat` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
#' @return `Seurat` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ã‚»ãƒ«ã‚¿ã‚¤ãƒ—æƒ…å ±ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚
run_sctype_and_update_seurat <- function(seurat_obj) {
 
  # ### å¤‰æ›´ç‚¹ 2: å„ã‚¹ãƒ†ãƒƒãƒ—ã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ  ###
  message("[scType Step 1/5] Preparing scripts and marker files...")
  sctype_url <- "https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/gene_sets_prepare.R"
  sctype_script_path <- "gene_sets_prepare.R"
  if (!file.exists(sctype_script_path)) {
    download.file(sctype_url, sctype_script_path)
    message("Downloaded gene_sets_prepare.R")
  }
  
  db_url <- "https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_short.xlsx"
  db_path <- "ScTypeDB_short.xlsx"
  if (!file.exists(db_path)) {
    download.file(db_url, db_path)
    message("Downloaded ScTypeDB_short.xlsx")
  }
  
  source(sctype_script_path)
  message("[scType Step 2/5] Loading gene sets database for 'Immune system'...")
  # Suppress warnings from HGNChelper about non-approved gene symbols in the database
  suppressWarnings({
    gs_list <- gene_sets_prepare(db_path, "Immune system")
  })
  
  message("[scType Step 3/5] Performing scType scoring...")
  es.max <- sctype_score(
    scRNAseqData = GetAssayData(seurat_obj, assay = "RNA", layer = "data"),
    scaled = FALSE,
    gs = gs_list$gs_positive,
    gs2 = gs_list$gs_negative
  )
  message("Scoring completed. Dimension of score matrix: ", paste(dim(es.max), collapse = " x "))
  
  message("[scType Step 4/5] Identifying top cell types...")
  n_gs <- names(gs_list$gs_positive)
  es.max.cl <- apply(es.max, 2, function(x) {
    if (max(x) > 0) {
      n_gs[which.max(x)]
    } else {
      "Unknown"
    }
  })
  message("Cell types identified. First 6 results: ", paste(head(es.max.cl), collapse = ", "))
  
  message("[scType Step 5/5] Adding 'sctype_celltype' to metadata...")
  seurat_obj@meta.data$sctype_celltype <- es.max.cl
  
  # æœ€å¾Œã®ç¢ºèª
  if("sctype_celltype" %in% colnames(seurat_obj@meta.data)){
      message("âœ… Success! 'sctype_celltype' column was added to Seurat object metadata.")
  } else {
      message("âŒ Failure! 'sctype_celltype' column was NOT added.")
  }
  
  return(seurat_obj)
}

run_seurat_object <- function(myReactives) {
  req(myReactives$seurat_object)
  seurat_object <- myReactives$seurat_object
  
  tryCatch({
    message("--- [Seurat Process] Starting basic Seurat processing ---")
    
    # --- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨QC ---
    message("[Seurat Process Step 1/7] Adding metadata and calculating mitochondrial percentage...")
    if(is.null(rownames(seurat_object@meta.data))) rownames(seurat_object@meta.data) <- colnames(seurat_object)
    seurat_object@meta.data <- seurat_object@meta.data %>%
      tibble::rownames_to_column("barcode") %>%
      mutate(sample = tryCatch(str_remove(barcode, "^.+-" ), error = function(e) { 
        warning("Could not extract sample from barcode."); NA_character_ 
      })) %>%
      tibble::column_to_rownames("barcode")
    seurat_object[["percent.mt"]] <- Seurat::PercentageFeatureSet(seurat_object, pattern = "^MT-")
    message("Completed metadata and QC.")

    # --- æ­£è¦åŒ– ---
    message("[Seurat Process Step 2/7] Normalizing data...")
    seurat_object <- Seurat::NormalizeData(seurat_object)
    message("Completed NormalizeData.")

    # --- å¤‰å‹•éºä¼å­ã®æ¤œå‡º ---
    message("[Seurat Process Step 3/7] Finding variable features...")
    seurat_object <- Seurat::FindVariableFeatures(seurat_object, selection.method = "vst", nfeatures = 2000)
    message("Completed FindVariableFeatures.")

    # --- ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° ---
    message("[Seurat Process Step 4/7] Scaling data...")
    # all.genes <- rownames(seurat_object)
    # seurat_object <- Seurat::ScaleData(seurat_object, features = all.genes)
    seurat_object <- Seurat::ScaleData(seurat_object)
    message("Completed ScaleData.")

    # --- PCA ---
    message("[Seurat Process Step 5/7] Running PCA...")
    seurat_object <- Seurat::RunPCA(seurat_object, features = Seurat::VariableFeatures(object = seurat_object), npcs = 50)
    # PCAã®çµæœãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if ("pca" %in% names(seurat_object@reductions)) {
      message("âœ… RunPCA successful. PCA dimensions: ", paste(dim(seurat_object[['pca']]), collapse = " x "))
    } else {
      stop("âŒ RunPCA failed. No 'pca' reduction found in the object.")
    }

    # --- UMAP & t-SNE ---
    dims_to_use <- 1:min(30, ncol(seurat_object[['pca']]))
    message("Using dimensions 1:", max(dims_to_use), " for UMAP and t-SNE.")
    
    message("[Seurat Process Step 6/7] Running UMAP...")
    seurat_object <- Seurat::RunUMAP(seurat_object, dims = dims_to_use)
    # UMAPã®çµæœãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if ("umap" %in% names(seurat_object@reductions)) {
      message("âœ… RunUMAP successful.")
    } else {
      warning("âŒ RunUMAP failed or did not complete. No 'umap' reduction found.")
    }

    message("[Seurat Process Step 7/7] Running t-SNE...")
    seurat_object <- Seurat::RunTSNE(seurat_object, dims = dims_to_use)
    # t-SNEã®çµæœãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if ("tsne" %in% names(seurat_object@reductions)) {
      message("âœ… RunTSNE successful.")
    } else {
      warning("âŒ RunTSNE failed or did not complete. No 'tsne' reduction found.")
    }
    
    # --- ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚° ---
    # UMAP/t-SNEã®å¾Œã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
    message("[Seurat Process] Finding neighbors and clusters...")
    seurat_object <- Seurat::FindNeighbors(seurat_object, dims = dims_to_use)
    seurat_object <- Seurat::FindClusters(seurat_object, resolution = 0.5)
    message("Clustering complete.")

    myReactives$seurat_object <- seurat_object
    myReactives$meta.data <- seurat_object@meta.data
    # saveRDS(myReactives$seurat_object, 'seurat_object.rds') # å€‹åˆ¥ã®ä¿å­˜ã¯ä¸è¦ã«
    
    message("--- [Seurat Process] All steps finished successfully! ---")
    
  }, error = function(e) {
    # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    message("!!!!!!!!!! Error in run_seurat_object !!!!!!!!!!")
    message("Error message: ", e$message)
    shinyalert::shinyalert("Seurat Processing Error", e$message, type = "error")
  })
  
  return(myReactives)
}

# ã“ã®é–¢æ•°ã¯å¤‰æ›´ãªã—ã§OKã§ã™ï¼
fileUpload <- function(input, myReactives) {
  myReactives$h5_path <- input$h5$datapath
  myReactives$tcr_path <- input$tcr$datapath
  myReactives$bcr_path <- input$bcr$datapath
  return(myReactives)
}


# (ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã®æ¨å¥¨è¨˜è¿°)
#' @importFrom dplyr %>% mutate case_when relocate starts_with coalesce across ends_with na_if select all_of any_of filter distinct full_join rename_with rename everything
#' @importFrom stringr str_c str_replace_all
#' @importFrom tidyselect everything
#' @importFrom readr read_csv
#' @importFrom scRepertoire combineTCR
#' @importFrom stats setNames
#' @importFrom rlang sym .data

# --- å®šæ•°å®šç¾© ---
PREFIX_TCR_PAIR  <- "TCR_pair_"
PREFIX_TCR_ALPHA <- "TCR_TRA_" # Alphaé– (TRA)
PREFIX_TCR_BETA  <- "TCR_TRB_" # Betaé– (TRB)

PREFIX_BCR_PAIR  <- "BCR_pair_" # Assuming this constant is needed for BCR processing


# --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°å®šç¾© ---
# (csv_to_tcr_pair_dataframe, csv_to_tcr_tra_dataframe, csv_to_tcr_trb_dataframe, merge_tcr, paste_existing_cols ã¯å¤‰æ›´ãªã—)
# (çœç•¥ã®ãŸã‚ã€ã“ã“ã§ã¯å†æ²ã—ã¾ã›ã‚“)
# --- (çœç•¥ã•ã‚ŒãŸãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°) ---
#' @title CSVã‹ã‚‰TCRãƒšã‚¢é–ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»æ•´å½¢
#' @description æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰scRepertoire::combineTCRã‚’ä½¿ç”¨ã—ã¦
#'              ãƒšã‚¢é–ãƒ‡ãƒ¼ã‚¿ (ä¸»ã«TRA/TRB) ã‚’æŠ½å‡ºã—ã€æ•´å½¢ã—ã¾ã™ã€‚
#'              åŒä¸€barcodeã«è¤‡æ•°Î±/Î²é–ãŒã‚ã‚‹å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ (filterMulti=TRUE)ã€‚
#' @param csv_path `character(1)`. å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚
#' @param sample_name `character(1)`. combineTCRã§ä½¿ç”¨ã™ã‚‹ä¸€æ™‚çš„ãªã‚µãƒ³ãƒ—ãƒ«åã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ "temp_sample"ã€‚
#' @param id_name `character(1)`. combineTCRã§ä½¿ç”¨ã™ã‚‹ä¸€æ™‚çš„ãªIDåã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ "temp_id"ã€‚
#' @return `data.frame`. æ•´å½¢ã•ã‚ŒãŸTCRãƒšã‚¢é–æƒ…å ±ã€‚åˆ—åã¯ `PREFIX_TCR_PAIR` ä»˜ä¸ã€‚
csv_to_tcr_pair_dataframe <- function(csv_path,
                                      sample_name = "temp_sample",
                                      id_name = "temp_id") {

  barcode_prefix <- paste0(sample_name, "_", id_name, "_")
  tcr_raw <- tryCatch({
    readr::read_csv(csv_path, show_col_types = FALSE)
  }, error = function(e) {
    stop("Error reading CSV file: ", csv_path, "\n", e$message)
    return(NULL)
  })
  if (is.null(tcr_raw)) return(NULL)

  pair_list <- tryCatch({
    scRepertoire::combineTCR(tcr_raw, samples = sample_name, ID = id_name, filterMulti = TRUE, removeNA = TRUE)
  }, error = function(e) {
    stop("Error in combineTCR: ", e$message)
    return(NULL)
  })

  if (is.null(pair_list) || length(pair_list) == 0 || is.null(pair_list[[1]])) {
    warning("combineTCR did not return valid pair data.")
    return(data.frame()) # ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿”ã™
  }
  pair <- pair_list[[1]]

  pair <- pair %>%
    dplyr::mutate(barcode = stringr::str_replace_all(barcode, pattern = barcode_prefix, replacement = "")) %>%
    dplyr::select(-dplyr::any_of(c("sample", "ID"))) %>%
    dplyr::rename_with(~ stringr::str_c(PREFIX_TCR_PAIR, .), dplyr::everything())

  return(pair)
}

# Assuming csv_to_bcr_pair_dataframe exists in this file,
# analogous to csv_to_tcr_pair_dataframe, and contains the problematic call.
# The following is a hypothetical reconstruction to show the fix.
#' @title CSVã‹ã‚‰BCRãƒšã‚¢é–ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»æ•´å½¢
#' @description æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰scRepertoire::combineBCRã‚’ä½¿ç”¨ã—ã¦
#'              ãƒšã‚¢é–ãƒ‡ãƒ¼ã‚¿ (ä¸»ã«IGH/IGL/IGK) ã‚’æŠ½å‡ºã—ã€æ•´å½¢ã—ã¾ã™ã€‚
#' @param csv_path `character(1)`. å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚
#' @param sample_name `character(1)`. combineBCRã§ä½¿ç”¨ã™ã‚‹ä¸€æ™‚çš„ãªã‚µãƒ³ãƒ—ãƒ«åã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ "temp_sample"ã€‚
#' @param id_name `character(1)`. combineBCRã§ä½¿ç”¨ã™ã‚‹ä¸€æ™‚çš„ãªIDåã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ "temp_id"ã€‚
#' @return `data.frame`. æ•´å½¢ã•ã‚ŒãŸBCRãƒšã‚¢é–æƒ…å ±ã€‚åˆ—åã¯ `PREFIX_BCR_PAIR` ä»˜ä¸ã€‚
csv_to_bcr_pair_dataframe <- function(csv_path,
                                      sample_name = "temp_sample",
                                      id_name = "temp_id") {

  barcode_prefix <- paste0(sample_name, "_", id_name, "_")
  bcr_raw <- tryCatch({
    readr::read_csv(csv_path, show_col_types = FALSE)
  }, error = function(e) {
    stop("Error reading CSV file: ", csv_path, "\n", e$message)
    return(NULL)
  })
  if (is.null(bcr_raw)) return(NULL)

  pair_list <- tryCatch({
    # FIX: combineBCR does NOT have filterMulti = TRUE. Removed it.
    scRepertoire::combineBCR(bcr_raw, samples = sample_name, ID = id_name, removeNA = TRUE)
  }, error = function(e) {
    stop("Error in combineBCR: ", e$message)
    return(NULL)
  })

  if (is.null(pair_list) || length(pair_list) == 0 || is.null(pair_list[[1]])) {
    warning("combineBCR did not return valid pair data.")
    return(data.frame()) # ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿”ã™
  }
  pair <- pair_list[[1]]

  pair <- pair %>%
    dplyr::mutate(barcode = stringr::str_replace_all(barcode, pattern = barcode_prefix, replacement = "")) %>%
    dplyr::select(-dplyr::any_of(c("sample", "ID"))) %>%
    dplyr::rename_with(~ stringr::str_c(PREFIX_BCR_PAIR, .), dplyr::everything())

  return(pair)
}

#' @title CSVã‹ã‚‰TCR Alphaé–(TRA)ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»æ•´å½¢
#' @description æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰TRAé–ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€
#'              barcodeã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ã¦æ•´å½¢ã—ã¾ã™ã€‚
#' @param csv_path `character(1)`. å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚
#' @return `data.frame`. æ•´å½¢ã•ã‚ŒãŸTCR TRAæƒ…å ±ã€‚åˆ—åã¯ `PREFIX_TCR_ALPHA` ä»˜ä¸ã€‚
csv_to_tcr_tra_dataframe <- function(csv_path){

  tcr_raw <- tryCatch({
    readr::read_csv(csv_path, show_col_types = FALSE)
  }, error = function(e) {
    stop("Error reading CSV file: ", csv_path, "\n", e$message)
    return(NULL)
  })
  if (is.null(tcr_raw) || !"chain" %in% names(tcr_raw) || !"barcode" %in% names(tcr_raw)) {
    warning("CSV file must contain 'chain' and 'barcode' columns.")
    return(data.frame()) # ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãç©ºã‚’è¿”ã™
  }

  TRA <- tcr_raw %>%
    dplyr::filter(chain == 'TRA') %>%
    dplyr::distinct(barcode, .keep_all = TRUE) %>%
    dplyr::rename_with(~ stringr::str_c(PREFIX_TCR_ALPHA, .), dplyr::everything())

  return(TRA)
}

#' @title CSVã‹ã‚‰TCR Betaé–(TRB)ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»æ•´å½¢
#' @description æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰TRBé–ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€
#'              barcodeã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ã¦æ•´å½¢ã—ã¾ã™ã€‚
#' @param csv_path `character(1)`. å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚
#' @return `data.frame`. æ•´å½¢ã•ã‚ŒãŸTCR TRBæƒ…å ±ã€‚åˆ—åã¯ `PREFIX_TCR_BETA` ä»˜ä¸ã€‚
csv_to_tcr_trb_dataframe <- function(csv_path){

  tcr_raw <- tryCatch({
    readr::read_csv(csv_path, show_col_types = FALSE)
  }, error = function(e) {
    stop("Error reading CSV file: ", csv_path, "\n", e$message)
    return(NULL)
  })
  if (is.null(tcr_raw) || !"chain" %in% names(tcr_raw) || !"barcode" %in% names(tcr_raw)) {
    warning("CSV file must contain 'chain' and 'barcode' columns.")
    return(data.frame()) # ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãç©ºã‚’è¿”ã™
  }

  TRB <- tcr_raw %>%
    dplyr::filter(chain == 'TRB') %>%
    dplyr::distinct(barcode, .keep_all = TRUE) %>%
    dplyr::rename_with(~ stringr::str_c(PREFIX_TCR_BETA, .), dplyr::everything())

  return(TRB)
}

#' @title TCRå„é–ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
#' @description ãƒšã‚¢é–ã€Alphaé–(TRA)ã€Betaé–(TRB)ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’barcodeã‚’ã‚­ãƒ¼ã«ã—ã¦çµåˆã—ã¾ã™ã€‚
#' @param pair `data.frame`. `csv_to_tcr_pair_dataframe` ã®å‡ºåŠ›ã€‚
#' @param TRA `data.frame`. `csv_to_tcr_tra_dataframe` ã®å‡ºåŠ›ã€‚
#' @param TRB `data.frame`. `csv_to_tcr_trb_dataframe` ã®å‡ºåŠ›ã€‚
#' @return `data.frame`. çµåˆã•ã‚ŒãŸTCRãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã€‚
merge_tcr <- function(pair, TRA, TRB){

  pair_barcode_col <- paste0(PREFIX_TCR_PAIR, "barcode")
  tra_barcode_col  <- paste0(PREFIX_TCR_ALPHA, "barcode")
  trb_barcode_col  <- paste0(PREFIX_TCR_BETA, "barcode")

  # pair ãŒç©ºãªã‚‰ç©ºã‚’è¿”ã™
  if (nrow(pair) == 0) {
      warning("Input 'pair' data frame is empty in merge_tcr. Returning empty data frame.")
      return(data.frame())
  }
  # TRA ã¾ãŸã¯ TRB ãŒç©ºã®å ´åˆã§ã‚‚çµåˆã¯å¯èƒ½ (full_joinã®ãŸã‚)
  if (nrow(TRA) == 0) warning("Input 'TRA' data frame is empty in merge_tcr.")
  if (nrow(TRB) == 0) warning("Input 'TRB' data frame is empty in merge_tcr.")


  tcr_merged <- dplyr::full_join(pair, TRA, by = stats::setNames(tra_barcode_col, pair_barcode_col))
  tcr_merged <- dplyr::full_join(tcr_merged, TRB, by = stats::setNames(trb_barcode_col, pair_barcode_col))

  return(tcr_merged)
}

#' @title å­˜åœ¨ã™ã‚‹åˆ—ã®å€¤ã‚’é€£çµã™ã‚‹å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
#' @description ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¨åˆ—åã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’å—ã‘å–ã‚Šã€å­˜åœ¨ã™ã‚‹åˆ—ã®å€¤ã‚’è¡Œã”ã¨ã«é€£çµã€‚
#' @param df `data.frame`. å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã€‚
#' @param cols `character`. é€£çµã—ãŸã„åˆ—åã®ãƒ™ã‚¯ãƒˆãƒ«ã€‚
#' @return `character`. å„è¡Œã«ã¤ã„ã¦é€£çµã•ã‚ŒãŸæ–‡å­—åˆ—ãƒ™ã‚¯ãƒˆãƒ«ã€‚
paste_existing_cols <- function(df, cols) {
  existing_cols <- intersect(cols, names(df))
  if (length(existing_cols) == 0) {
    return(rep(NA_character_, nrow(df)))
  }
  # apply ã‚’ä½¿ã†ã‚ˆã‚Š rowwise + paste0/unite ã®æ–¹ãŒ dplyr çš„ã‹ã‚‚ã—ã‚Œãªã„ãŒã€
  # NAå‡¦ç†ã‚’å«ã‚ã‚‹ã¨ apply ã®æ–¹ãŒç°¡æ½”ãªå ´åˆã‚‚ã‚ã‚‹
  apply(df[, existing_cols, drop = FALSE], 1, function(row_values) {
      # NA ã‚’ç©ºæ–‡å­—ã«å¤‰æ›ã—ã¦ã‹ã‚‰çµåˆ
      row_values_no_na <- ifelse(is.na(row_values), "", row_values)
      paste0(row_values_no_na, collapse = "")
  })
}
# --- ãƒ¡ã‚¤ãƒ³é–¢æ•°å®šç¾© (ä¿®æ­£ç‰ˆ) ---

#' @title CSVã‹ã‚‰TCRãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•° (ä»£è¡¨IDä¿®æ­£ãƒ»ãƒšã‚¢å¿…é ˆç‰ˆ)
#' @description æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰TCRãƒ‡ãƒ¼ã‚¿ (ä¸»ã«TRA/TRB) ã‚’èª­ã¿è¾¼ã¿ã€
#'              ãƒšã‚¢é–ã€Alphaé–ã€Betaé–ã«åˆ†å‰²ãƒ»æ•´å½¢ã—ãŸå¾Œã€çµåˆã—ã€TRBé–ã®IDã‚’
#'              å…ƒã«ä»£è¡¨ID (`raw_clonotype_id` ã¨ `exact_subclonotype_id`) ã‚’æ ¼ç´ã—ã€
#'              å…¨é•·é…åˆ—ã‚’ç”Ÿæˆã—ã€åˆ—é †åºã‚’æ•´ãˆã€barcodeåˆ—åã‚’å¤‰æ›´ã—ã¾ã™ã€‚
#'              `raw_consensus_id` ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
#'              `exact_subclonotype_id` ã¯ TRB ã® `raw_clonotype_id` ã¨
#'              `exact_subclonotype_id` ã‚’ `_` ã§é€£çµã—ãŸå€¤ã«ãªã‚Šã¾ã™ã€‚
#'              **æœ€çµ‚çš„ã«TRAé–ã¨TRBé–ã®ä¸¡æ–¹ãŒå­˜åœ¨ã™ã‚‹è¡Œã®ã¿ã‚’ä¿æŒã—ã¾ã™ã€‚**
#' @param csv_path `character(1)`. å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚
#' @return `data.frame`. å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã€TRA/TRBãƒšã‚¢ãŒå­˜åœ¨ã™ã‚‹è¡Œã®ã¿ã‚’å«ã‚€TCRãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã€‚
#'         å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚„ã€æœ‰åŠ¹ãªãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€
#'         ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¾ãŸã¯è­¦å‘Šä»˜ãã®éƒ¨åˆ†çš„ãªçµæœã‚’è¿”ã™ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
tcr_csv_to_dataframe <- function(csv_path){

  # --- 1. å…¥åŠ›ãƒã‚§ãƒƒã‚¯ ---
  if (!file.exists(csv_path)) {
    stop("Input CSV file not found: ", csv_path)
    return(NULL)
  }

  # --- 2. ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ»æ•´å½¢ ---
  pair_data <- csv_to_tcr_pair_dataframe(csv_path)
  tra_data  <- csv_to_tcr_tra_dataframe(csv_path)
  trb_data  <- csv_to_tcr_trb_dataframe(csv_path)

  if (is.null(pair_data) || nrow(pair_data) == 0 || !paste0(PREFIX_TCR_PAIR, "barcode") %in% names(pair_data)) {
      warning("No valid paired TCR data found or extracted. Returning an empty data frame.")
      return(data.frame())
  }
  if (is.null(tra_data) || nrow(tra_data) == 0) {
      warning("No TRA data extracted. Final result might be empty after filtering.")
  }
  if (is.null(trb_data) || nrow(trb_data) == 0) {
      warning("No TRB data extracted. Final result might be empty after filtering.")
  }

  # --- 3. ãƒ‡ãƒ¼ã‚¿çµåˆ ---
  merged_df <- merge_tcr(pair_data, tra_data, trb_data)

  pair_barcode_col_check <- paste0(PREFIX_TCR_PAIR, "barcode")
  if (nrow(merged_df) == 0 || !pair_barcode_col_check %in% names(merged_df)) {
    warning("Merging TCR data resulted in an empty data frame or missing key barcode column. Returning the empty frame.")
    return(merged_df)
  }

  # --- 4. ä»£è¡¨IDç”Ÿæˆã¨ä¸è¦åˆ—å‰Šé™¤ (â˜…ä¿®æ­£ç®‡æ‰€â˜…) ---
  # TRBé–ã®IDã‚’å…ƒã«ä»£è¡¨IDã‚’ç”Ÿæˆ
  trb_clonotype_col <- paste0(PREFIX_TCR_BETA, "raw_clonotype_id")
  trb_subclonotype_col <- paste0(PREFIX_TCR_BETA, "exact_subclonotype_id")
  # raw_consensus_id ã¯ã“ã“ã§ç”Ÿæˆã—ãªã„

  # å‰Šé™¤å¯¾è±¡ã®å…ƒã®IDåˆ—å (TRA, TRB, Pair) - consensusã‚‚å«ã‚€
  cols_to_remove <- c(
    paste0(PREFIX_TCR_ALPHA, c("raw_clonotype_id", "raw_consensus_id", "exact_subclonotype_id")),
    paste0(PREFIX_TCR_BETA, c("raw_clonotype_id", "raw_consensus_id", "exact_subclonotype_id")),
    paste0(PREFIX_TCR_PAIR, c("raw_clonotype_id", "raw_consensus_id", "exact_subclonotype_id"))
  )
  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹åˆ—ã®ã¿ã‚’å‰Šé™¤å¯¾è±¡ã¨ã™ã‚‹
  cols_to_remove_existing <- intersect(cols_to_remove, names(merged_df))

  processed_df <- merged_df %>%
    dplyr::mutate(
      # raw_clonotype_id ã¯ TRBç”±æ¥ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨
      raw_clonotype_id = if (trb_clonotype_col %in% names(.)) .data[[trb_clonotype_col]] else NA_character_,
      # exact_subclonotype_id ã¯ TRBç”±æ¥ã® raw_clonotype_id ã¨ exact_subclonotype_id ã‚’é€£çµ
      exact_subclonotype_id = dplyr::case_when(
        # ä¸¡æ–¹ã®åˆ—ãŒå­˜åœ¨ã—ã€ã‹ã¤ä¸¡æ–¹ã®å€¤ãŒ NA ã§ãªã„å ´åˆã®ã¿é€£çµ
        trb_clonotype_col %in% names(.) & trb_subclonotype_col %in% names(.) &
          !is.na(.data[[trb_clonotype_col]]) & !is.na(.data[[trb_subclonotype_col]])
          ~ stringr::str_c(.data[[trb_clonotype_col]], .data[[trb_subclonotype_col]], sep = "_"),
        # ãã‚Œä»¥å¤–ã®å ´åˆã¯ NA
        TRUE ~ NA_character_
      )
      # raw_consensus_id ã¯ã“ã“ã§ç”Ÿæˆã—ãªã„
    ) %>%
    # ä¸è¦ã«ãªã£ãŸå…ƒã®TRA/TRB/Pairã®IDåˆ—(+ consensus åˆ—)ã‚’å‰Šé™¤
    dplyr::select(-dplyr::any_of(cols_to_remove_existing)) %>%
    # ã‚‚ã—ãƒãƒ¼ã‚¸ã‚„ä»–ã®å‡¦ç†ã§ raw_consensus_id åˆ—ãŒæ®‹ã£ã¦ã—ã¾ã£ãŸå ´åˆã«å‚™ãˆã¦æ˜ç¤ºçš„ã«å‰Šé™¤
    dplyr::select(-dplyr::any_of("raw_consensus_id"))


  # --- 5. åˆ—é †åºã®æ•´ç† (â˜…ä¿®æ­£ç®‡æ‰€â˜…) ---
  # ä»£è¡¨IDåˆ—ã€ãƒšã‚¢åˆ—ã€Alphaåˆ—ã€Betaåˆ—ã®é †ã«ä¸¦ã¹æ›¿ãˆ (consensus ã‚’é™¤å¤–)
  processed_df <- processed_df %>%
    dplyr::relocate(
      # ä»£è¡¨IDåˆ—ã‚’å…ˆé ­ã« (raw_consensus_id ã‚’é™¤å¤–)
      dplyr::any_of(c("raw_clonotype_id", "exact_subclonotype_id")),
      # æ¬¡ã«å„ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤åˆ—
      dplyr::starts_with(PREFIX_TCR_PAIR),
      dplyr::starts_with(PREFIX_TCR_ALPHA),
      dplyr::starts_with(PREFIX_TCR_BETA),
      .before = tidyselect::everything() # ãã®ä»–ã®åˆ—ã®å‰ã«é…ç½®
    )

  # --- 6. å…¨é•·é…åˆ—ã®ç”Ÿæˆ ---
  regions_nt <- c("fwr1_nt", "cdr1_nt", "fwr2_nt", "cdr2_nt", "fwr3_nt", "cdr3_nt", "fwr4_nt")
  regions_aa <- c("fwr1", "cdr1", "fwr2", "cdr2", "fwr3", "cdr3", "fwr4")

  tra_nt_cols <- paste0(PREFIX_TCR_ALPHA, regions_nt)
  trb_nt_cols <- paste0(PREFIX_TCR_BETA, regions_nt)
  tra_aa_cols <- paste0(PREFIX_TCR_ALPHA, regions_aa)
  trb_aa_cols <- paste0(PREFIX_TCR_BETA, regions_aa)

  processed_df <- processed_df %>%
    dplyr::mutate(
      !!paste0(PREFIX_TCR_ALPHA, "full_length_nt") := paste_existing_cols(., tra_nt_cols),
      !!paste0(PREFIX_TCR_BETA, "full_length_nt") := paste_existing_cols(., trb_nt_cols),
      !!paste0(PREFIX_TCR_ALPHA, "full_length_aa") := paste_existing_cols(., tra_aa_cols),
      !!paste0(PREFIX_TCR_BETA, "full_length_aa") := paste_existing_cols(., trb_aa_cols)
    ) %>%
    dplyr::mutate(
      dplyr::across(
        dplyr::ends_with("full_length_nt") | dplyr::ends_with("full_length_aa"),
        ~ dplyr::na_if(., "")
      )
    )

  # --- 7. æœ€çµ‚çš„ãªåˆ—æ•´ç† (barcode) ---
  pair_barcode_col_rename <- paste0(PREFIX_TCR_PAIR, "barcode")
  if (!"barcode" %in% names(processed_df) && pair_barcode_col_rename %in% names(processed_df)) {
    processed_df <- processed_df %>%
      dplyr::rename(barcode = !!rlang::sym(pair_barcode_col_rename))
  } else if (!"barcode" %in% names(processed_df)) {
      warning(paste("Column", pair_barcode_col_rename, "not found for renaming and 'barcode' column also does not exist."))
  }

  if ("barcode" %in% names(processed_df)) {
    processed_df <- processed_df %>% dplyr::relocate(barcode)
  }

  # --- 8. TRA/TRBãƒšã‚¢ãŒå­˜åœ¨ã™ã‚‹è¡Œã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
  tra_key_col <- paste0(PREFIX_TCR_ALPHA, "chain")
  trb_key_col <- paste0(PREFIX_TCR_BETA, "chain")

  if (tra_key_col %in% names(processed_df) && trb_key_col %in% names(processed_df)) {
      final_df <- processed_df %>%
          dplyr::filter(!is.na(.data[[tra_key_col]]) & !is.na(.data[[trb_key_col]]))

      if(nrow(final_df) == 0 && nrow(processed_df) > 0) {
          warning("Filtering removed all rows. No barcodes with both TRA and TRB chains found after merging.")
      }

  } else {
      missing_cols <- c()
      if (!tra_key_col %in% names(processed_df)) missing_cols <- c(missing_cols, tra_key_col)
      if (!trb_key_col %in% names(processed_df)) missing_cols <- c(missing_cols, trb_key_col)
      warning(paste("Key columns for filtering (", paste(missing_cols, collapse=", "), ") not found in the merged data frame. Skipping the final filtering step."))
      final_df <- processed_df
  }

  # --- 9. çµæœã‚’è¿”ã™ ---
  return(final_df)
}

#' @title CSVã‹ã‚‰BCRãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
#' @description æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰BCRãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€
#'              ãƒšã‚¢é–ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»æ•´å½¢ã—ã¾ã™ã€‚
#'              æœ€çµ‚çš„ã«barcodeåˆ—ã‚’ãƒªãƒãƒ¼ãƒ ã—ã€å…ˆé ­ã«ç§»å‹•ã•ã›ã¾ã™ã€‚
#' @param csv_path `character(1)`. å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚
#' @return `data.frame`. å‡¦ç†ãŒå®Œäº†ã—ãŸBCRãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã€‚
#'         å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚„ã€æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€
#'         ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
bcr_csv_to_dataframe <- function(csv_path) {
  # --- 1. å…¥åŠ›ãƒã‚§ãƒƒã‚¯ ---
  if (!file.exists(csv_path)) {
    stop("Input CSV file not found: ", csv_path)
    return(NULL)
  }

  # --- 2. ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ»æ•´å½¢ ---
  pair_data <- csv_to_bcr_pair_dataframe(csv_path)

  if (is.null(pair_data) || nrow(pair_data) == 0 || !paste0(PREFIX_BCR_PAIR, "barcode") %in% names(pair_data)) {
      warning("No valid paired BCR data found or extracted. Returning an empty data frame.")
      return(data.frame())
  }

  # --- 3. æœ€çµ‚çš„ãªåˆ—æ•´ç† (barcode) ---
  pair_barcode_col_rename <- paste0(PREFIX_BCR_PAIR, "barcode")
  if (!"barcode" %in% names(pair_data) && pair_barcode_col_rename %in% names(pair_data)) {
    processed_df <- pair_data %>%
      dplyr::rename(barcode = !!rlang::sym(pair_barcode_col_rename))
  } else if (!"barcode" %in% names(pair_data)) {
      warning(paste("Column", pair_barcode_col_rename, "not found for renaming and 'barcode' column also does not exist."))
      processed_df <- pair_data
  } else {
    processed_df <- pair_data
  }

  if ("barcode" %in% names(processed_df)) {
    processed_df <- processed_df %>% dplyr::relocate(barcode)
  }

  # --- 4. çµæœã‚’è¿”ã™ ---
  return(processed_df)
}

# â˜… addCelltype ã¯å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ä¾å­˜ã™ã‚‹ãŸã‚æ³¨æ„ãŒå¿…è¦ â˜…
addCelltype <- function(myReactives) {
  req(myReactives$seurat_object)

  # --- 1. å®Ÿè¡Œå‰ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åˆ—åã‚’å–å¾— ---
  original_cols <- colnames(myReactives$seurat_object@meta.data)

  # --- 2. sctypeã®å®Ÿè¡Œ ---
  # å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã¨å®Ÿè¡Œ
  tryCatch({
    # local=TRUE ã§ç¾åœ¨ã®ç’°å¢ƒã«é–¢æ•°ã‚’èª­ã¿è¾¼ã‚€
    source("https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/sctype_wrapper.R", local = TRUE)

    if (exists("run_sctype", mode = "function")) {
      # sctypeã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©
      sctype_name_param <- "sctype_classification"
      sctype_tissue_param <- "Immune system"

      # sctypeã‚’å®Ÿè¡Œ
      myReactives$seurat_object <- run_sctype(
        myReactives$seurat_object,
        assay = "RNA",
        scaled = TRUE,
        known_tissue_type = sctype_tissue_param,
        custom_marker_file = "https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_short.xlsx",
        name = sctype_name_param
      )

      # --- 3. è¿½åŠ ã•ã‚ŒãŸåˆ—ã‚’ç‰¹å®šã—ã€ãƒªãƒãƒ¼ãƒ  ---
      new_cols <- colnames(myReactives$seurat_object@meta.data)
      added_cols <- setdiff(new_cols, original_cols)

      # sctypeãŒä¸€æ™‚çš„ã«è¿½åŠ ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ 'cluster' åˆ—ã‚’é™¤å¤–
      sctype_result_col <- setdiff(added_cols, "cluster")

      # çµæœåˆ—ãŒ1ã¤ã ã‘è¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
      if (length(sctype_result_col) == 1) {
        # å®Ÿéš›ã«è¿½åŠ ã•ã‚ŒãŸåˆ—ã‚’ 'Celltype' ã«ãƒªãƒãƒ¼ãƒ 
        myReactives$seurat_object@meta.data <- myReactives$seurat_object@meta.data %>%
          dplyr::rename(Celltype = !!rlang::sym(sctype_result_col))
        message("Successfully renamed column '", sctype_result_col, "' to 'Celltype'.")
      } else if (length(sctype_result_col) > 1) {
        warning("sctype added multiple unexpected columns: ", paste(sctype_result_col, collapse = ", "), ". Could not reliably determine which to rename to 'Celltype'.")
      } else {
        # äºˆæ¸¬ã—ã¦ã„ãŸåˆ—åã‚‚è­¦å‘Šã«å«ã‚ã‚‹
        expected_col_name_raw <- paste0(sctype_name_param, "_", sctype_tissue_param)
        expected_col_name_clean <- make.names(expected_col_name_raw)
        warning("Could not find the sctype result column. Expected something like '", expected_col_name_clean, "' but found these new columns: ", paste(added_cols, collapse = ", "))
      }

      # --- 4. ä¸è¦ãªä¸€æ™‚åˆ—ã‚’å‰Šé™¤ ---
      # sctype_wrapper.R ã¯ 'cluster' ã¨ã„ã†åˆ—ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
      # ä»¥å‰ã¯ã“ã®é–¢æ•°å†…ã§å‰Šé™¤ã—ã¦ã„ã¾ã—ãŸãŒã€å¾Œç¶šã®UIæ›´æ–°å‡¦ç†ãŒ
      # ã“ã®'cluster'åˆ—ã®å­˜åœ¨ã‚’å‰æã¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
      # ã“ã“ã§ã¯å‰Šé™¤ã—ãªã„ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚å¾Œç¶šã®å‡¦ç†ã§ä¸è¦ãªåˆ—ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
      # if ("cluster" %in% added_cols) {
      #   myReactives$seurat_object@meta.data$cluster <- NULL
      # }
    } else {
      warning("run_sctype function not found after sourcing script.")
    }
  }, error = function(e) {
    warning("Failed to source or run sctype: ", e$message)
  })
  return(myReactives)
}